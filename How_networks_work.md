<!-- 《网络是怎样连接的》笔记 -->

# 1. 浏览器生成消息
1. **域名**：服务器的名称，如 `www.google.com`
1. ***URL***: uniform resource locator, 统一资源定位符。
    - `http`, `ftp`, `file`, `mailto` 等表示访问数据源的机制、方法，即协议。
        - ***FTP***: file transfer protocol
        - ***HTTP***: hypertext transfer protocol
<!--     
    1. 用 HTTP 服务器访问 Web 服务器
        - `http://user:password@www.glasscom.com:80/dir/file1.html` 
        - 协议 （+ 用户名） （+ 密码） + Web 服务器域名 （+ 端口号） + 文件路径名
    1. 用 FTP 协议下载、上传文件
        - `ftp://user:password@ftp.glasscom.com:21/dir/file1.html`
        -  协议 （+ 用户名） （+ 密码） + FTP 服务器域名 （+ 端口号） + 文件路径名
    1. 读取本地文件
        - `file://localhost/c:/path/file1.zip`
        - 协议 （+ 计算机名） + 文件路径名
    1. 发送电子邮件
        - `mailto:tone@glasscom.com`
        - 协议 + 邮箱地址
    1. 阅读新闻组文章
        - `news:comp.protocols.tcp-ip`
        - 协议 + 新闻组名
     -->
2. URI: uniform resource identifier, 统一资源标识符。
3. 路由器：一种对包进行转发的设备。
4. 集线器：一种对包进行转发的设备，分为中继式和交换式。
3. ***DNS***: domain name system, 域名服务系统。
4. ***Socket*** **库**：用于调用操作系统网络功能的程序组件集合。
    - 最早为 BSD(UNIX) 的 C 语言网络库。
1. **协议栈**：操作系统内部的网络控制软件，也叫 TCP/IP 驱动。
2. 套接字：收发数据的两台计算机之间的数据通道两端的数据出入口。
- World Wide Web 是最早开发的浏览器兼 HTML 编辑器的名称。
- 很多服务器采用 `www` 这样的命名。
## 生成 HTTP 请求
### 浏览器解析 URL
- URL 中文件路径名为 `/` 表示根目录。
- 服务器不允许文件名和目录名设置成相同。
- 对于每个目录，服务器会设置好默认访问的文件名，通常为 `index.html` 或 `default.html`, 因此要访问的文件名省略时也能正常访问默认设置的文件。
    - `https://sb.io` 和 `https://sb.io/` 会访问到根目录下的默认文件。
    - `https://sb.io/dir/` 会访问到 `/dir/` 目录下的默认文件。
    - `https://sb.io/dir` 的情况，若服务器上存在名为 `dir` 的文件，则访问到该文件；否则，若存在 `/dir/` 目录，则访问到该目录的默认文件。
- 浏览器解析完 URL 后，使用 HTTP 协议来访问 Web 服务器。
### 浏览器生成 HTTP 消息
- HTTP 请求包含“对什么”和“进行什么操作”。
    - “对什么”部分称为 URI, 
    - “进行什么操作”部分称为方法或 HTTP 谓词。
- 请求消息
    1. 请求行 - `<方法><空格><URI><空格><HTTP 版本>`
    2. 消息头 - 附加信息，每行包含一个头字段（`<字段名>: <字段值>`）。
        - 头字段分通用头，请求头，响应头。
    3. 空行
    3. 消息体 - 客户端向服务器发送的数据，如 POST 方法发送的表单数据。
        - 使用 GET 方法时消息体为空，无需数据，服务器通过识别 GET 方法和 URI 即可操作。
- 响应消息
    1. 状态行 - `<HTTP 版本><空格><状态码><空格><响应短语>`
        - （状态码） `1xx` - 告知请求的处理进度和情况
        - `2xx` - 成功
        - `3xx` - 需要进一步操作
        - `4xx` - 客户端错误
        - `5xx` - 服务器错误 
    2. 消息头
    3. 空行
    4. 消息体 - 服务器向客户端发送的数据。
        - 消息体的内容作为二进制数据处理，通过消息头中的 `Content-Type` 字段来定义（MIME 类型）。
- 每条请求消息中只能有一个 URI, 所以每次只能获取一个文件。
- HTTP 协议将 HTML 文档和图片单独处理，每个都需要单独发送请求。
- 浏览器遇到图片相关的标签时，会在屏幕上预留显示图片的空间，然后发送请求消息请求相应图片。
- 生成 HTTP 消息后，浏览器委托操作系统将消息发送给 Web 服务器。
    - 浏览器本身不具备将消息发送至网络的功能。
    - 发送消息的功能对于所有应用程序都通用，因而交由操作系统实现。
## 向 DNS 服务器查询 Web 服务器的 IP 地址
### IP 地址
- **子网**是通过集线器连接起来的计算机群组。拖过集线器连接起来的所有设备都属于同一个子网
- 子网通过路由器连接成网络。
- IP 地址是一串 32 比特的数字，8 比特（1 字节）为一组分为 4 组。
- IP 地址分为**网络号**和**主机号**。
    - 网络号分配给整个子网。
    - 主机号分配给子网中的网络设备（硬件）。
- 网络号和主机号加起来总共 32 比特，但两部分的具体结构不固定，组建网络时用户可以自行决定分配关系。
- 通过**子网掩码**来确定 IP 地址的内部结构。
    - 子网掩码也是一串 32 比特的数字， 1 的部分表示网络号，0 的部分表示主机号。
        - `10.1.2.3/255.255.255.0` 和 `10.1.2.3/24` 均表示网络号为 `10.1.2`, 主机号为 `3`.
    - 主机号部分全为 0 表示整个子网而非子网中的某台设备；全为 1 表示向子网上的所有设备发送包，即对整个子网广播。
### 浏览器调用 Socket 库中的解析器，解析器委托 OS 协议栈向 DNS 服务器发送查询 IP 请求
- 域名与 IP 并用：域名易记；IP 定长，且占用字节数少，设计 TCP/IP 架构时尚无法实现当今的搜索引擎。
    - 使用虚拟主机功能的服务器可能无法通过 IP 地址访问。
- 计算机上的 DNS 客户端叫解析器 (resolver), 是 Socket 库中的一个程序组件。
- 解析器委托操作系统内部的协议栈向 DNS 服务器发送查询某域名对应 IP 的请求。
    - `<内存地址> = gethostbyname("www.google.com");`
    - 解析器本身不具备使用网络收发数据的功能。
- 要向 DNS 服务器发送查询消息，要知道 DNS 服务器的本身的 IP 地址，此 IP 地址已预先在操作系统的 TCP/IP设置项目里设置好。
- DNS 返回的响应消息包含查询到的 IP 地址，解析器将其取出并写入浏览器指定的内存地址。
- 浏览器向 Web 服务器发送请求时从内存取出 IP 地址，与 HTTP 请求一起委托给操作系统发送。
## DNS 服务器接力
### DNS 服务器根据查询消息返回匹配的 IP 地址
- 查询消息包含
    1. 域名 - 服务器、邮件服务器（@ 后的部分）的名称。
    2. Class - 用来识别网络类型的信息。如今 Class 值只有代表互联网的 IN.
    3. 记录类型 - A 表示域名对应的是 IP 地址；MX 表示域名对应的是邮件服务器，等等。
        - A: address
        - MX: Mail eXchange
- DNS 服务器从域名和 IP 对照表查找匹配记录并返回 IP 地址。
### 域名的层次结构
- 域名层次由句点分隔，越靠右层级越高。
- 相当于一个层级的部分称为域。
- 一个域作为一个整体存放在 DNS 服务器中。
- 管理下级域的 DNS 服务器的 IP 地址注册到它的上级 DNS 服务器中，以此类推。
    - `mail.google.com` 中，管理 `mail.google.com` 域的 DNS 服务器的 IP 地址注册到管理 `google.com` 域的 DNS 服务器；管理 `google.com` 域的 DNS 服务器的 IP 地址注册到管理 `com` 域的 DNS 服务器。
- 通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地址，也就可以向下级 DNS 服务器发送查询请求。
- 根域：`.` 表示，书写时往往被省略；保存着[顶级域](https://www.iana.org/domains/root/db) DNS 服务器的信息。
- 共有 13 个 IP 地址分配给根域 DNS 服务器，这些 IP 地址几乎不会改变。
- 根域 DNS 服务器的信息包含在 DNS 服务器程序的配置文件中，安装好 DNS 服务器程序后就自动配置好了。
- 理论上，客户端访问最近的 DNS 服务器，从根域 DNS 服务器开始依次查找目标 DNS 服务器。
- 实际使用中，上级域和下级域可能共享一台 DNS 服务器。
- DNS 服务器有缓存功能，可以记住之前查询过的域名。缓存中的信息可以直接返回响应，接下来的查询可以从缓存处继续进行。
- DNS 服务器的响应消息会告知客户端响应的来源：缓存或是负责管理该域名的 DNS 服务器。
- 由于注册信息会发生改变，DNS 服务器的缓存信息有有效期，过期后的数据会从缓存中删除。
## 浏览器委托协议栈发送消息
- 浏览器按照指定顺序调用 Socket 库中的程序组件，这些程序组件再委托操作系统中的协议栈来执行数据收发操作。
- 这一过程中 Socket 库中的程序组件不执行任何实质性操作，应用程序的委托内容被原原本本传递给协议栈。
- 服务器和客户端分别创建套接字，套接字连接起来形成管道（数据通道）。
    - 服务器上的应用程序先创建套接字，等待客户端上的应用程序向该套接字连接管道。（创建阶段）
    - 客户端上的应用程序调用 Socket 库的 socket 组件创建套接字；调用 Socket 库的 connect 组件（传描述符，服务器 IP 和端口号三个参数）从该套接字延伸出管道连接到服务器端的套接字。（连接阶段）
        - 套接字创建完成后，协议栈返回一个**描述符**，用于识别不同应用程序委托协议栈创建的套接字。应用程序将描述符保存在内存中。
        - 协议栈还会为套接字随机分配端口号，协议栈在执行连接操作时将该端口号告知服务器。
        - 连接成功后协议栈将对方的 IP 地址和端口号等信息保存在套接字中。
    - 将数据送入套接字极客收发数据。（通信阶段）
        - 应用程序调用 Socket 库的 write 组件，传入描述符（可以找到对应套接字，进而得到保存其中的服务器信息）和 HTTP 请求（待发送数据），委托协议栈发送至服务器。
        - 调用 Socket 库中的 read 组件将响应消息保存到应用程序访问得到的接收缓冲区。
    - 数据发送完毕后调用 Socket 库的 close 组件断开管道并删除套接字。（断开阶段）
        - 根据应用种类不同，服务器和客户端都可能先执行 close 操作。
        - HTTP 1.1 可以再依次连接中收发多个请求和响应。所有请求完成后浏览器主动触发断开连接的操作。
- 描述符用于一台计算机内部的应用程序识别其委托协议栈创建的套接字，网络连接的另一方无从知晓描述符信息。
- IP 和端口号用于让通信的另一方识别连接对象的套接字。